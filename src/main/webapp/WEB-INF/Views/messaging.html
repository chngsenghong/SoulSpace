<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>SoulSpace - Messages</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #1a1a1a; height: 100vh; overflow: hidden; }
        .main-content { margin-left: 16rem; height: 100vh; display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
        @media (max-width: 1024px) { .main-content { margin-left: 0; } }
        .messaging-container { display: flex; flex: 1; background: white; overflow: hidden; }
        .conversations-sidebar { width: 320px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; background: #fff; }
        .sidebar-header { padding: 1.5rem 1rem 1rem; border-bottom: 1px solid #e5e7eb; }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 500; margin-bottom: 1rem; }
        .conversations-list { flex: 1; overflow-y: auto; }
        .conversation-item { padding: 1rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; gap: 0.75rem; align-items: center; transition: all 0.2s; }
        .conversation-item:hover { background: #f9fafb; }
        .conversation-item.active { background: #eff6ff; border-left: 3px solid #2563eb; }
        .conversation-avatar { width: 3rem; height: 3rem; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; flex-shrink: 0; position: relative; font-size: 1rem; }
        .conversation-details { flex: 1; min-width: 0; }
        .conversation-header { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }
        .conversation-name { font-weight: 500; color: #1f2937; }
        .conversation-time { font-size: 0.75rem; color: #6b7280; }
        .conversation-preview { font-size: 0.85rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #f9fafb; }
        .chat-header { padding: 1rem 1.5rem; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; }
        .message { display: flex; gap: 0.75rem; margin-bottom: 0.5rem; max-width: 75%; }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message.received { align-self: flex-start; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; line-height: 1.5; color: #374151; }
        .message.sent .message-bubble { background: #2563eb; color: white; border-bottom-right-radius: 0.25rem; }
        .message.received .message-bubble { border-bottom-left-radius: 0.25rem; }
        .chat-input-container { padding: 1rem 1.5rem; background: white; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
        .chat-input-wrapper { display: flex; gap: 0.75rem; align-items: flex-end; background: #f9fafb; padding: 0.5rem; border-radius: 1.5rem; border: 1px solid #e5e7eb; }
        .chat-input { flex: 1; padding: 0.5rem 1rem; border: none; background: transparent; font-size: 1rem; font-family: inherit; outline: none; }
        .send-btn { width: 2.5rem; height: 2.5rem; border: none; background: #2563eb; color: white; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .mobile-menu-btn { display: none; }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
            .conversations-sidebar { width: 100%; }
            .chat-area { display: none; }
            .chat-area.active { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280; }
    </style>
</head>
<body>
    <div th:replace="~{navigation :: sidebar-fragment}"></div>
    
    <main class="main-content">
        <div class="messaging-container">
             <div class="conversations-sidebar" id="sidebarList">
                  <div class="sidebar-header">
                      <h2>Messages</h2>
                  </div>
                  <div class="conversations-list">
                      <div th:each="convo : ${conversations}" 
                           th:class="'conversation-item ' + (${convo.partner.id == activeChatId} ? 'active' : '')"
                           th:onclick="'window.location.href=\'' + @{/messaging(chatWith=${convo.partner.id})} + '\''">
                          
                          <div class="conversation-avatar" th:text="${convo.partner.initials}">U</div>
                          
                          <div class="conversation-details">
                              <div class="conversation-header">
                                  <span class="conversation-name" th:text="${convo.partner.firstName} + ' ' + ${convo.partner.lastName}">User Name</span>
                                  <span class="conversation-time" th:text="${convo.lastMessage.formattedTime}">Time</span>
                              </div>
                              <p class="conversation-preview" th:text="${convo.lastMessage.content}">Message preview...</p>
                          </div>
                      </div>
                  </div>
             </div>

             <div class="chat-area" id="chatWindow" th:classappend="${activeChatId != null} ? 'active' : ''">
                  
                  <div class="empty-state" th:if="${activeChatId == null}">
                      <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                      <p style="margin-top:1rem;">Select a conversation to start messaging</p>
                  </div>

                  <th:block th:if="${activeChatId != null}">
                      <div class="chat-header">
                          <div style="display:flex; align-items:center; gap:1rem;">
                              <button class="mobile-menu-btn" onclick="window.location.href='/soulspace/messaging'">‚Üê</button>
                              <div class="conversation-avatar" th:text="${activePartner.initials}">U</div>
                              <span style="font-weight:600;" th:text="${activePartner.firstName} + ' ' + ${activePartner.lastName}">User Name</span>
                          </div>
                      </div>

                      <div class="chat-messages" id="messagesContainer">
                          <div th:each="msg : ${activeMessages}" 
                               th:class="'message ' + (${msg.sender.id == session.userId} ? 'sent' : 'received')">
                              <div class="message-bubble" th:text="${msg.content}">Message text</div>
                          </div>
                      </div>

                      <div class="chat-input-container">
                          <form th:action="@{/messaging/send}" method="post" class="chat-input-wrapper">
                              <input type="hidden" name="receiverId" th:value="${activeChatId}" />
                              <input type="text" name="content" class="chat-input" placeholder="Type a message..." required autocomplete="off" />
                              <button type="submit" class="send-btn">
                                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                              </button>
                          </form>
                      </div>
                  </th:block>
             </div>
        </div>
    </main>

    <script>
        // Auto-scroll to bottom of chat
        const msgContainer = document.getElementById('messagesContainer');
        if (msgContainer) {
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
    </script>
</body>
</html>

